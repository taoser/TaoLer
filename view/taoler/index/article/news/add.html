{extend name="public/base" /}
{block name="title"}发表帖子{/block}
{block name="link"}
<link rel="stylesheet" href="{$Request.domain}/static/res/css/plyr.css" charset="utf-8"/>
<script src="/static/tinymce/tinymce.min.js"></script>
<script>
  tinymce.init({
    selector: '#mytextarea',
    language:'zh-Hans',
    branding: false,
    plugins: "lists advlist anchor autosave code charmap codesample directionality emoticons image imagetools insertdatetime link table media pagebreak wordcount preview axupimgs nonbreaking print searchreplace toc", //依赖lists插件
    toolbar1: "formatselect fontselect fontsizeselect | bold italic underline strikethrough link hr removeformat | forecolor backcolor  | alignleft aligncenter alignright alignjustify |bullist numlist  outdent indent | blockquote codesample code",
    toolbar2:"subscript superscript anchor charmap emoticons nonbreaking pagebreak | image media axupimgs table | toc  searchreplace  insertdatetime | ltr rtl undo redo wordcount | print preview",
    autosave_prefix: "editor-autosave-{path}{query}-{id}-",
    autosave_restore_when_empty: true,
    //图片上传
    images_upload_url: "{:url('article/uploads')}?type=image",
    imagetools_cors_hosts: ['mydomain.com', 'otherdomain.com'],
    imagetools_proxy: 'proxy.php',
    images_upload_handler: function (blobInfo, succFun, failFun) {
        var xhr, formData;
        var file = blobInfo.blob();//转化为易于理解的file对象
        xhr = new XMLHttpRequest();
        xhr.withCredentials = false;
        xhr.open('POST', "{:url('article/uploads')}?type=image");
        xhr.onload = function() {
            var json;
            if (xhr.status != 200) {
                failFun('HTTP Error: ' + xhr.status);
                return;
            }
            json = JSON.parse(xhr.responseText);
            if (!json || typeof json.location != 'string') {
                failFun('Invalid JSON: ' + xhr.responseText);
                return;
            }
            succFun(json.location);
        };
        formData = new FormData();
        formData.append('file', file, file.name );
        xhr.send(formData);
    },
    // 文件上传
    file_picker_callback: function(callback, value, meta) {
      //文件分类
      var filetype='.pdf, .txt, .zip, .rar, .7z, .doc, .docx, .xls, .xlsx, .ppt, .pptx, .mp3, .mp4';
        //后端接收上传文件的地址
        var upurl="{:url('article/uploads')}";
        //为不同插件指定文件类型及后端地址
        switch(meta.filetype){
            case 'image':
                filetype='.jpg, .jpeg, .png, .gif';
                upurl="{:url('article/uploads')}?type=image";
                break;
            case 'media':
                filetype='.mp3, .mp4';
                upurl="{:url('article/uploads')}?type=video";
                break;
            case 'file':
            default:
        }
        //模拟出一个input用于添加本地文件
        var input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', filetype);
            input.click();
            input.onchange = function() {
            var file = this.files[0];

            var xhr, formData;
            console.log(file.name);
            xhr = new XMLHttpRequest();
            xhr.withCredentials = false;
            xhr.open('POST', upurl);
            xhr.onload = function() {
                var json;
                if (xhr.status != 200) {
                    failure('HTTP Error: ' + xhr.status);
                    return;
                }
                json = JSON.parse(xhr.responseText);
                if (!json || typeof json.location != 'string') {
                    failure('Invalid JSON: ' + xhr.responseText);
                    return;
                }
                callback(json.location);
            };
            formData = new FormData();
            formData.append('file', file, file.name );
            xhr.send(formData);

            //下方被注释掉的是官方的一个例子
            //放到下面给大家参考
            
            /*var reader = new FileReader();
            reader.onload = function () {
                // Note: Now we need to register the blob in TinyMCEs image blob
                // registry. In the next release this part hopefully won't be
                // necessary, as we are looking to handle it internally.
                var id = 'blobid' + (new Date()).getTime();
                var blobCache =  tinymce.activeEditor.editorUpload.blobCache;
                var base64 = reader.result.split(',')[1];
                var blobInfo = blobCache.create(id, file, base64);
                blobCache.add(blobInfo);

                // call the callback and populate the Title field with the file name
                callback(blobInfo.blobUri(), { title: file.name });
            };
            reader.readAsDataURL(file);*/
          };
    },
    codesample_languages: [
        {text: 'HTML/XML', value: 'markup'},
        {text: 'JavaScript', value: 'javascript'},
        {text: 'CSS', value: 'css'},
        {text: 'PHP', value: 'php'},
        {text: 'Ruby', value: 'ruby'},
        {text: 'Python', value: 'python'},
        {text: 'Java', value: 'java'},
        {text: 'C', value: 'c'},
        {text: 'C#', value: 'csharp'},
        {text: 'C++', value: 'cpp'}
    ],
    fontsize_formats: '12px 14px 16px 18px 24px 36px 48px 56px 72px',
    font_formats: '微软雅黑=Microsoft YaHei,Helvetica Neue,PingFang SC,sans-serif;苹果苹方=PingFang SC,Microsoft YaHei,sans-serif;宋体=simsun,serif;仿宋体=FangSong,serif;黑体=SimHei,sans-serif;Arial=arial,helvetica,sans-serif;Arial Black=arial black,avant garde;Book Antiqua=book antiqua,palatino;',
    default_link_target: "_blank",
    link_assume_external_targets:true,
    menubar:true,
    //移动端
    mobile: {
        plugins: [ 'autosave', 'lists', 'autolink', 'image', 'media' ],
        toolbar: [ 'undo', 'bold', 'italic', 'styleselect', 'image', 'media' ]
    },
    // 同步
    setup: function(editor){ 
      editor.on('change',function(){ editor.save(); });
    }
  });
  </script>
{/block}
{block name="column"}{/block}
{block name="content"}
<div class="layui-container fly-marginTop">
  <div class="fly-panel" pad20 style="padding-top: 5px">
    <!--<div class="fly-none">没有权限</div>-->
    <div class="layui-form layui-form-pane">
      <div class="layui-tab layui-tab-brief" lay-filter="user">
        <ul class="layui-tab-title">
          <li class="layui-this">{:lang('add post')}222<!-- 编辑帖子 --></li>
        </ul>
        <div class="layui-tab-content" id="LAY_ucm" style="padding: 20px 0">
          <div class="layui-tab-item layui-show">
            {if config('taoler.config.is_post') == 1}
            <div class="layui-row layui-col-space15 layui-form-item">
              <div class="layui-col-md3">
                <label class="layui-form-label">{:lang('special column')}</label>
                <div class="layui-input-block">
                  <select lay-verify="required" name="cate_id" lay-filter="column">
                    <option></option>
                    {volist name="cateList" id="cate"}
                    <option value="{$cate.id}" {if($Request.param.cate == $cate.ename)} selected {/if}>{:cookie('think_lang') == 'en-us' ? $cate.ename : $cate.catename}</option>
                    {/volist}
                  </select>
                </div>
              </div>
              <div class="layui-col-md8">
                <label for="L_title" class="layui-form-label">{:lang('title')}</label>
                <div class="layui-input-block">
                  <input type="text" id="L_title" name="title" required lay-verify="required" autocomplete="off" class="layui-input" style="position:relative;" value=""/>
                  <input type="hidden" id="L_title_color" name="title_color" autocomplete="off" class="layui-input" />
                  <input type="hidden" name="user_id" value="{:session('user_id')}" />
                  <div class="layui-input bdsug layui-hide">
                    <ul class="wordlist">
                    </ul>
                  </div>
                </div>
              </div>
              {if ($user.auth == 1)}
              <div class="layui-col-md1">
                <div id="color"></div>
              </div>
              {/if}
            </div>
            <div class="layui-row layui-col-space15 layui-form-item layui-hide" id="LAY_quiz">
              <div class="layui-col-md3">
                <label class="layui-form-label">所属产品</label>
                <div class="layui-input-block">
                  <select name="project">
                    <option></option>
                    <option value="layui">layui</option>
                    <option value="独立版layer">独立版layer</option>
                    <option value="独立版layDate">独立版layDate</option>
                    <option value="LayIM">LayIM</option>
                    <option value="Fly社区模板">Fly社区模板</option>
                  </select>
                </div>
              </div>
              <div class="layui-col-md3">
                <label class="layui-form-label" for="L_version">版本号</label>
                <div class="layui-input-block">
                  <input type="text" id="L_version" value="" name="version" autocomplete="off" class="layui-input" />
                </div>
              </div>
              <div class="layui-col-md6">
                <label class="layui-form-label" for="L_browser">浏览器</label>
                <div class="layui-input-block">
                  <input type="text" id="L_browser" value="" name="browser" placeholder="浏览器名称及版本，如：IE 11" autocomplete="off" class="layui-input" />
                </div>
              </div>
            </div>


            <div class="layui-form-item layui-form-text">
              <div class="layui-input-block">
              <textarea id="mytextarea" name="content" required lay-verify="required" placeholder="{:lang('please input the content')}"></textarea>
              </div>
            </div>

            <!-- <div class="layui-form-item layui-form-text">
              <div class="layui-input-block">
                <textarea
                  id="L_content"
                  name="content"
                  required
                  lay-verify="required"
                  placeholder="{:lang('please input the content')}"
                  class="layui-textarea fly-editor"
                  style="height: 260px"
                ></textarea>
              </div>
            </div> -->
            <div class="layui-form-item">
              <div class="layui-inline">
                <label class="layui-form-label">{:lang('enclosure')}</label>
                <div class="layui-input-inline" style="width: 190px">
                  <input type="text" class="layui-input" name="upzip" value="" placeholder="zip,image文件" title="上传附件" />
                </div>
                <button type="button" class="layui-btn" id="zip-button"><i class="layui-icon"></i>{:lang('uploads')}</button>
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">{:lang('描述')}</label>
              <div class="layui-input-block">
                <textarea name="description" class="layui-textarea" placeholder="SEO描述"></textarea>
              </div>
            </div>
            <div class="layui-form-item">
              <div class="layui-inline">
                <label class="layui-form-label">{:lang('add tags')}</label>
                <div class="layui-input-inline" style="width: 190px">
                  <input type="text" class="layui-input" name="tags" value="" placeholder="多个用空格隔开" title="添加标签" />
                </div>
                <button type="button" class="layui-btn" id="article-tags-button">{:lang('add')}</button>
              </div>
            </div>
            <div class="layui-form-item">
              <div class="layui-btn-container"></div>
            </div>

            <!--div class="layui-form-item">
                <div class="layui-inline">
                  <label class="layui-form-label">悬赏飞吻</label>
                  <div class="layui-input-inline" style="width: 190px;">
                    <select name="experience">
                      <option value="20">20</option>
                      <option value="30">30</option>
                      <option value="50">50</option>
                      <option value="60">60</option>
                      <option value="80">80</option>
                    </select>
                  </div>
                  <div class="layui-form-mid layui-word-aux">发表后无法更改飞吻</div>
                </div>
              </div-->

            {if config('taoler.config.post_captcha') == 1}
            <div class="layui-form-item">
              <label for="L_vercode" class="layui-form-label">{:lang('captcha')}</label>
              <div class="layui-input-inline">
                <input
                  type="text"
                  id="L_vercode"
                  name="captcha"
                  required
                  lay-verify="required"
                  placeholder="{:lang('please input the captcha')}"
                  autocomplete="off"
                  class="layui-input"
                />
              </div>
              <div class="layui-form-mid layui-word-aux" style="padding-top: 0px !important">
                <img
                  id="captcha"
                  src="{:captcha_src()}"
                  onclick="this.src='{:captcha_src()}?'+Math.random();"
                  style="float: left; cursor: pointer"
                  alt="captcha"
                />
              </div>
            </div>
            {/if}
            <div class="layui-form-item">
              <button type="submit" class="layui-btn" lay-filter="article-add" lay-submit id="add">{:lang('post now')}</button>
            </div>
          </div>
          {else /}
          <div class="layui-form-item">抱歉，系统维护中，暂时禁止发帖！</div>
          {/if}
        </div>
      </div>
    </div>
  </div>
</div>
{include file="public/menu" /} {/block}

{block name="script"}
<script>
  layui.use(["fly", "form", "colorpicker", "upload", "plyr"], function () {
    var $ = layui.jquery,
      fly = layui.fly,
      form = layui.form,
      colorpicker = layui.colorpicker,
      upload = layui.upload,
      plyr = layui.plyr;

    // 如果你是采用模版自带的编辑器，你需要开启以下语句来解析。
    $(".layui-textarea").each(function () {
      var othis = $(this),
        html = othis.html();
      othis.html(fly.content(html));
    });

     // 改变标题颜色
    colorpicker.render({
      elem: "#color",
      color: "#393d49",
      predefine: true, // 开启预定义颜色
      done: function (color) {
        //譬如你可以在回调中把得到的 color 赋值给表单
        $("#L_title_color").val(color);
        $("#L_title").css("color", color);
      },
    });

    //上传附件
    upload.render({
      elem: "#zip-button",
      url: "{:url('article/uploads')}", //改成您自己的上传接口
      data: { type: "zip" },
      accept: "file", //普通文件
      done: function (res) {
        if (res.status == 0) {
          $('input[name="upzip"]').val(res.url);
          layer.msg("上传成功");
        } else {
          layer.msg(res.msg);
        }
      },
    });

    // 发布文章
    form.on("submit(article-add)", function (data) {
      var field = data.field;
      var numArr = new Array();
      $(".layui-btn-container")
        .children("button")
        .each(function () {
          numArr.push($(this).val()); //添加至数组
        });
      tags = numArr.lenth ? "" : numArr.join(",");
      var index = layer.load(1);
      $.ajax({
        type: "post",
        url: "{:url('article/add')}",
        data: {
          cate_id: field.cate_id,
          title: field.title,
          title_color: field.title_color,
          user_id: field.user_id,
          tiny_content: field.tiny_content,
          content: field.content,
          upzip: field.upzip,
          tags: tags,
          description: field.description,
          captcha: field.captcha,
        },
        dataType: "json",
        success: function (data) {
          if (data.code == 0) {
            layer.msg(data.msg, { icon: 6, time: 2000 }, function () {
              location.href = data.url;
            });
          } else {
            layer.open({ title: "发布失败", content: data.msg, icon: 5, anim: 6 });
            layui.jquery("#captcha").attr("src", "{:captcha_src()}?" + Math.random());
          }
          layer.close(index);
        },
      });
      return false;
    });

    // 获取描述的内容
    // $("#L_content111").bind('input propertychange', function(){
    //   var content = $(this).val();
    //   setTimeout(function(){
    //         $.ajax({
    //         type:"post",
    //         url:"{:url('article/getDescription')}",
    //         data:{"content":content},
    //         daType:"json",
    //         success:function (data){
    //           if (data.code == 0) {
    //             $('[name="description"]').val(data.data);
    //           }
    //         }
    //       })
    //     }, 5000)
    //   return false;
    // })

    // 获取描述的内容 非实时获取，停止输入后获取
    var flag = false;
    var othis = $("#L_content");
    othis.on("compositionstart", function () {
      flag = true;
    });
    othis.on("compositionend", function () {
      flag = false;
      desc(othis.val());
    });

    // othis.on('input', function (event) {
    //   // 忽略一切非直接输入，不做逻辑处理
    //   if (!flag) todo(event.target.value);
    // });

    function desc(content) {
      $.ajax({
        type: "post",
        url: "{:url('article/getDescription')}",
        data: { content: content },
        daType: "json",
        success: function (data) {
          if (data.code == 0) {
            $('[name="description"]').val(data.data);
          }
        },
      });
    }

    // 手动添加tags
    $("#article-tags-button").on("click", function () {
      var tags = $("input[name='tags']").val();
      var flag = "off";
      getTags(tags, flag);
    });

    // 获取tag的内容
    var conf = "{:empty(config('taoler.baidu.client_id'))}";
    if (conf !== "1") {
      $("#L_title").on("blur", function () {
        var title = $(this).val();
        var flag = "on";
        // 清空上次生成的tag button
        $(".layui-btn-container")
          .children("button")
          .each(function () {
            $(this).remove();
          });
        getTags(title, flag);
      });
    }

    // 百度词条
    var baidu_title_switch = "{:config('taoler.config.baidu_title_switch')}";
    if(baidu_title_switch == 1) {
      $("#L_title").bind('input propertychange',function () {
          var title = $(this).val();
          var str = '';
          if(title.length > 0 ) {
            $.post("{:url('article/getWordList')}",{title:title},function(res){
              // 动态生成ur>li内容
              if (res.code == 0) {
                // 显示动态框
                $(".bdsug").removeClass('layui-hide');
                for (var i = 0; i < res.data.length; i++) {
                  //str += '<li data-key=' + res.data[i].q + '><b>' + res.data[i].q.replace(title,'') + '</b></li>';
                  str += '<li data-key=' + res.data[i].q + '><b>' + res.data[i].q + '</b></li>';
                }
                // 清空ul并追加li
                $('.wordlist').empty().append(str);
                // 点击李获取li值并复制给#L_title input的value
                $(".bdsug li").on('click',function(){
                  var word = $(this).attr('data-key');
                  var words = title + '(' + word + ')';
                  $("#L_title").val(words);
                  // 关闭动态框
                  $(".bdsug").addClass('layui-hide');
                });
              } else {
                $(".bdsug").addClass('layui-hide');
              }
            });
          } else {
            $(".bdsug").addClass('layui-hide');
          }
      });
    }  

    // 添加关键词button
    function getTags(tags, flag) {
      if (tags == "") {
        layer.msg("tag不能为空");
        return false;
      }

      //把得到的tags放进数组
      var numArr = new Array();
      $(".layui-btn-container")
        .children("button")
        .each(function () {
          numArr.push($(this).val()); //添加至数组
        });

      $.ajax({
        type: "post",
        url: "{:url('article/tags')}",
        data: { tags: tags, flag: flag },
        daType: "json",
        success: function (data) {
          if (data.code == 0) {
            for (var i = 0; i < data.data.length; i++) {
              if ($.inArray(data.data[i], numArr) < 0) {
                $(".layui-btn-container").append(
                  '<button type="button" class="layui-btn layui-btn-sm layui-btn-danger" value=' + data.data[i] + ">" + data.data[i] + " x" + "</button>"
                );
              }
            }
            $("input[name='tags']").val("");
          }
        },
      });
    }

    // 删除tag
    $(document).ready(function () {
      $(".layui-btn-container").on("click", "button", function () {
        $(this).remove();
      });
    });

    //加载播放器
    plyr.setup();
  });
</script>
{/block}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>新增页面</title>
  <link rel="stylesheet" href="/static/component/pear/css/pear.css" />
</head>
<body>
<form class="layui-form" action="">
  <div class="mainBox">
    <div class="main-container">
    <div class="layui-form-item">
      <label class="layui-form-label">名称</label>
      <div class="layui-input-inline">
        <select name="app_id" lay-verify="">
            {volist name="apps" id="vo"}
            <option value="{$vo.id}">{$vo.app_name}</option>
            {/volist}
          </select>
      </div>
    </div>
	<div class="layui-form-item">
      <label class="layui-form-label">版本</label>
      <div class="layui-input-inline">
        <input type="text" name="plugins_version" lay-verify="required" placeholder="请输入版本" autocomplete="off" class="layui-input">
      </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">简介</label>
        <div class="layui-input-inline">
        <textarea name="description" placeholder="请输入简介"  lay-verify="required"  class="layui-textarea"></textarea>
        </div>
      </div>
	<div class="layui-form-item">
      <label class="layui-form-label">价格</label>
      <div class="layui-input-inline">
        <input type="text" name="plugins_price" lay-verify="required" placeholder="请输入价格" autocomplete="off" class="layui-input">
      </div>
    </div>
    <div class="layui-form-item  layui-form-text">
      <label class="layui-form-label">压缩包</label>
      <div class="layui-input-inline">
        <input type="text" name="plugins_src" lay-verify="required" placeholder="请上传zip包" autocomplete="off" class="layui-input" >
      </div>
    </div>
	<div class="layui-form-item  layui-form-text">
      <label class="layui-form-label"></label>
      <div class="layui-input-inline">
       <button style="float: left;" type="button" class="layui-btn " id="upload-plugins">上传插件</button>
      </div>
    </div>
  </div>
  </div>
  <div class="bottom">
    <div class="button-container">
      <button type="submit" class="pear-btn pear-btn-primary pear-btn-sm" lay-submit="" lay-filter="plugins-save">
        <i class="layui-icon layui-icon-ok"></i>
        提交
      </button>
      <button type="reset" class="pear-btn pear-btn-sm">
        <i class="layui-icon layui-icon-refresh"></i>
        重置
      </button>
    </div>
  </div>
</form>
<script src="/static/component/layui/layui.js"></script>
<script src="/static/component/pear/pear.js"></script>

<script>
  layui.use(['form', 'upload'], function(){
    let $ = layui.jquery;
    let form = layui.form;
    let upload = layui.upload ;
    let layer = layui.layer;

    let UPLOAD_URL = "{:url('apps.plugins/uploadZip')}";
    let ADD_URL = "{:url('apps.plugins/add')}";

    form.on('submit(plugins-save)', function(data) {
      $.ajax({
        url: ADD_URL,
        data: JSON.stringify(data.field),
        dataType: 'json',
        contentType: 'application/json',
        type: 'post',
        success: function(result) {
          if (result.code === 0) {
            layer.msg(result.msg, {
              icon: 1,
              time: 1000
            }, function() {
              parent.layer.close(parent.layer.getFrameIndex(window
                      .name)); //关闭当前页
              parent.layui.table.reload("plugins-table");
            });
          } else {
            layer.msg(result.msg, {
              icon: 2,
              time: 1000
            });
          }
        }
      })
      return false;
    });

    upload.render({
      elem: '#upload-plugins'
      ,url: UPLOAD_URL
      ,data: {type:'zip'}
      ,accept: 'file'
      ,field: 'file'
      ,method: 'get'
      ,exts: 'zip|rar|7z'
      ,choose: function(obj){
        var loadIndex = layer.load(2);
      }
      ,done: function(res){
        layer.close(loadIndex)
        if(res.code === 0){
          $("input[name='plugins_src']").val(res.src);
          layer.msg(res.msg,{
            icon:6,
            tiye:2000
          });
        } else {
          layer.open({
            title:"上传失败",
            content:res.msg,
            icon:5,
            anim:6
          });
        }
      }
    });
  })
</script>
</body>
</html>



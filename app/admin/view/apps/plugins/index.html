<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>APP管理</title>
	<link rel="stylesheet" href="/static/component/pear/css/pear.css" />
</head>
<body class="pear-container">
<div class="layui-card">
	<div class="layui-card-body">
		<form class="layui-form" action="">
			<div class="layui-form-item">
				<div class="layui-form-item layui-inline">
					<label class="layui-form-label">名称</label>
					<div class="layui-input-inline">
						<input type="text" name="app_name" placeholder="" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item layui-inline">
					<button class="pear-btn pear-btn-md pear-btn-primary" lay-submit lay-filter="plugins-query">
						<i class="layui-icon layui-icon-search"></i>
						查询
					</button>
					<button type="reset" class="pear-btn pear-btn-md">
						<i class="layui-icon layui-icon-refresh"></i>
						重置
					</button>
				</div>
			</div>
		</form>
	</div>
</div>
<div class="layui-card">
	<div class="layui-card-body">
		<table id="plugins-table" lay-filter="plugins-table"></table>
	</div>
</div>

<script type="text/html" id="plugins-toolbar">
	<button class="pear-btn pear-btn-primary pear-btn-md" lay-event="add">
		<i class="layui-icon layui-icon-add-1"></i>
		新增
	</button>
	<button class="pear-btn pear-btn-danger pear-btn-md" lay-event="batchRemove">
		<i class="layui-icon layui-icon-delete"></i>
		删除
	</button>
</script>

<script type="text/html" id="plugins-bar">
	<button class="pear-btn pear-btn-primary pear-btn-sm" lay-event="edit"><i class="layui-icon layui-icon-edit"></i></button>
	<button class="pear-btn pear-btn-danger pear-btn-sm" lay-event="remove"><i class="layui-icon layui-icon-delete"></i></button>
</script>

<script type="text/html" id="plugins-enable">
	<input type="checkbox" name="status" value="{{d.id}}" lay-skin="switch" lay-text="启用|禁用" lay-filter="plugins-enable"  {{ d.status == 1 ? 'checked' : '' }} />
</script>

<script type="text/html" id="icon">
	<i class="layui-icon {{d.icon}}"></i>
</script>

<script src="/static/component/layui/layui.js"></script>
<script src="/static/component/pear/pear.js"></script>
<script>
	layui.use(['table','form','jquery'],function () {
		let table = layui.table;
		let form = layui.form;
		let $ = layui.jquery;

		let LIST = "{:url('apps.plugins/list')}";
		let CHECK = "{:url('apps.plugins/check')}";

		let cols = [[
			{type: 'numbers', fixed: 'left'},
			{field: 'plugins_name',title: '插件', width: 150},
			{field: 'plugins_title',title: '标题', width: 150},
			{field: 'plugins_version',title: '版本', width: 100},
			{field: 'plugins_author',title: '作者', width: 100},
			{field: 'description',title: '简介', minWidth: 200},
			{field: 'plugins_price',title: '价格(元)'},
			{field: 'status',title: '状态', width: 100, templet: '#plugins-enable'},
			{field: 'ctime',title: '时间', width: 150},
			{title: '操作', width: 150, align:'center', toolbar: '#plugins-bar'}
		]];


		table.render({
			elem: '#plugins-table',
			url: LIST,
			page: true,
			cols: cols,
			skin: 'line',
			toolbar: '#plugins-toolbar',
			defaultToolbar: [{
				title: '刷新',
				layEvent: 'refresh',
				icon: 'layui-icon-refresh',
			}, 'filter', 'print', 'exports']
		});

		table.on('tool(plugins-table)',function(obj){
			if (obj.event === 'remove') {
				window.remove(obj);
			} else if (obj.event === 'edit') {
				window.edit(obj);
			}
		})


		table.on('toolbar(plugins-table)', function(obj){
			if(obj.event === 'add'){
				window.add();
			} else if(obj.event === 'refresh'){
				window.refresh();
			} else if(obj.event === 'batchRemove'){
				window.batchRemove(obj);
			}  else if(obj.event === 'expandAll'){
				treetable.expandAll("#plugins-table");
			} else if(obj.event === 'foldAll'){
				treetable.foldAll("#plugins-table");
			}
		});

		form.on('submit(plugins-query)', function(data) {
			table.reload('plugins-table', {
				where: {app_name: data.field.app_name, page: 1}
			})
			return false;
		});

		// 审核
		form.on('switch(plugins-enable)', function(obj) {
			layer.tips(this.value + ' ' + this.name + '：' + obj.elem.checked, obj.othis);
			var status = obj.elem.checked ? 1 : -1;
			//执行帖子审核
			$.ajax({
				type:'post',
				url: CHECK,
				data:{id: this.value, status: status},
				dataType:'json',
				success:function(res){
					if(res.code === 0){
						layer.msg(res.msg,{icon:res.icon,time:2000});
					} else {
						layer.open({title:'审核失败',content:res.msg,icon:5,adim:6})
					}
					table.reload('plugins-list');
				}
			});
			return false;
		});


		window.add = function(){
			layer.open({
				type: 2,
				title: '新增',
				shade: 0.1,
				area: ['450px', '650px'],
				content: 'add.html'
			});
		}

		window.edit = function(obj){
			layer.open({
				type: 2,
				title: '修改',
				shade: 0.1,
				area: ['450px', '650px'],
				content: 'edit.html?id=' + obj.data.id
			});
		}
		window.remove = function(obj){
			layer.confirm('确定要删除?', {icon: 3, title:'提示'}, function(index){
				layer.close(index);
				let loading = layer.load();
				$.ajax({
					url: MODULE_PATH+"remove/"+obj.data['powerId'],
					dataType:'json',
					type:'delete',
					success:function(result){
						layer.close(loading);
						if(result.success){
							layer.msg(result.msg,{icon:1,time:1000},function(){
								obj.del();
							});
						}else{
							layer.msg(result.msg,{icon:2,time:1000});
						}
					}
				})
			});
		}
	})
</script>
</body>
</html>

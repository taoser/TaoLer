{extend name="public/admin_base" /}

{block name="body"}
        <div class="layui-card">
          <div class="layui-card-body">
            <form class="layui-form" wid100 lay-filter="">
				<div class="layui-form-item">
					<div class="layui-form-item layui-inline">
						<label class="layui-form-label">类型</label>
						<div class="layui-input-block">
							<select name="type" lay-verify="required" lay-filter="picwall-type">
								<option value="1">精彩回顾</option>
								<option value="2">视频集锦</option>
							</select>
						</div>
					</div>
					<div class="layui-form-item layui-inline">
						<button class="pear-btn pear-btn-md pear-btn-primary" lay-submit lay-filter="picwall-query">
							<i class="layui-icon layui-icon-search"></i>
							查询
						</button>
						<button type="reset" class="pear-btn pear-btn-md">
							<i class="layui-icon layui-icon-refresh"></i>
							重置
						</button>
					</div>
				</div> 
            </form>
          </div>
        </div>

		<div class="layui-card">
			<div class="layui-card-body">
				<table id="picwall-table" lay-filter="picwall-table"></table>
			</div>
		</div>

		<script type="text/html" id="picwall-toolbar">
			<button class="pear-btn pear-btn-primary pear-btn-md" lay-event="add">
				<i class="layui-icon layui-icon-add-1"></i>
				新增
			</button>
<!--			<button class="pear-btn pear-btn-danger pear-btn-md" lay-event="batchRemove">-->
<!--				<i class="layui-icon layui-icon-delete"></i>-->
<!--				删除-->
<!--			</button>-->
		</script>

		<script type="text/html" id="imgTpl">
			{{#  if(d.slid_type == "头部菜单"){ }}<i class="layui-icon {{d.slid_img}}"></i>{{# } else { }} {{# if(d.slid_img == "") { }}  {{# } else { }} <img src="{{d.slid_img}}" height="40" width="80">{{# } }} {{# } }}
		</script>
		<script type="text/html" id="picwall-bar">
			<button class="pear-btn pear-btn-primary pear-btn-sm" lay-event="see"><i class="layui-icon layui-icon-eye"></i></button>
<!--			<button class="pear-btn pear-btn-primary pear-btn-sm" lay-event="edit"><i class="layui-icon layui-icon-edit"></i></button>-->
			<button class="pear-btn pear-btn-danger pear-btn-sm" lay-event="remove"><i class="layui-icon layui-icon-delete"></i></button>
		</script>

		<script type="text/html" id="picwall-enable">
			<input type="checkbox" name="status" value="{{d.id}}" lay-skin="switch" lay-text="通过|禁用" lay-filter="picwall-enable" {{ d.status == 1 ? 'checked' : '' }} />
		</script>
  
{/block}
{block name="js"}
		<script>
		layui.use(['layer','table','form','common'], function(){
		var $ = layui.jquery
		,layer = layui.layer
		,table = layui.table
		,form = layui.form;
		let common = layui.common;

		let type = `<div>{{#  if(d.type === 1){ }}图片{{#  } else { }}视频{{#  } }}</div>`;

		let cols = [[ //表头
		   {title: '序号', type: 'numbers'}
		  ,{field: 'title', title: '标题', minWidth:150}
		  ,{field: 'description', title: '描述', minWidth:250}
		  ,{field: 'type', title: '类型', width:80, templet: type}
		  ,{field: 'industry', title: '行业', width: 80}
		  ,{field: 'pv', title: '浏览', width: 80, sort: true}
		  ,{field: 'create_time', title: '发布时间', width: 180}
		  ,{field: 'status', title: '状态', width: 100, templet: '#picwall-enable'}
		  ,{title:'操作', toolbar: '#picwall-bar', width:120}
		]];

		//第一个实例
		table.render({
		elem: '#picwall-table'
		,url: "{:url('addons.picwall.index/list')}" //数据接口
		,page: true //开启分页
		,cols: cols
		,skin: 'line'
		,toolbar: '#picwall-toolbar'
		,limit: 15
		,text: '对不起，加载出现异常！'
		});

			table.on('tool(picwall-table)', function(obj) {
				if (obj.event === 'remove') {
					window.remove(obj);
				} else if (obj.event === 'edit') {
					window.edit(obj);
				} else if (obj.event === 'see') {
					window.see(obj);
				}
			});

			table.on('toolbar(picwall-table)', function(obj) {
				if (obj.event === 'add') {
					window.add();
				} else if (obj.event === 'refresh') {
					window.refresh();
				} else if (obj.event === 'batchRemove') {
					window.batchRemove(obj);
				}
			});
			//筛选重载
			form.on('submit(picwall-query)', function(data) {
				table.reload('picwall-table', {
					where: data.field
				})
				return false;
			});
			// 选择重载
			form.on('select(picwall-type)', function(data){
			  $.post("{:url('addons.picwall.index/list')}", {type: data.value, limit: 1}, function (res){
					if (res.code === -1){
						layer.open({content:res.msg,icon:5,anim:6});
					}
				}
			);
			//执行重载
			  table.reload('picwall-table', {
				where: {type: data.value, limit: 1}
				,page: {
							curr: 1 //重新从第 1 页开始
						}
			  });
			});

			form.on('switch(picwall-enable)', function(obj) {
				var status = obj.elem.checked ? 1 : 0;
				//执行用户审核
				$.ajax({
					type:'post',
					url:"{:url('addons.picwall.index/check')}",
					data:{"id":this.value,"status":status},
					dataType:'json',
					success:function(res){
						if(res.code === 0){
							layer.msg(res.msg,{
										icon:res.icon,
										time:2000
									}
									//,function(){location.reload();}
							);
						} else {
							layer.open({
								title:'审核失败',
								content:res.msg,
								icon:5,
								adim:6
							})
						}
					}
				});
				return false;
			});

			window.add = function() {
				layer.open({
					type: 2,
					title: '新增',
					shade: 0.1,
					area: ['100%','100%'],
					content: 'add.html'
				});
			}

			window.see = function(obj) {
				layer.open({
					type: 2,
					title: '查看',
					shade: 0.1,
					area: ['100%','100%'],
					content: 'see.html?id=' + obj.data.id
				});
			}

			window.edit = function(obj) {
				layer.open({
					type: 2,
					title: '修改',
					shade: 0.1,
					area: ['500px', '500px'],
					content: 'edit.html?id=' + obj.data.id
				});
			}

			window.remove = function(obj) {

				layer.confirm('确定要删除?', {
					icon: 3,
					title: '提示'
				}, function(index) {
					layer.close(index);
					let loading = layer.load();
					$.ajax({
						url: "{:url('addons.picwall.index/delete')}?id=" + obj.data['id'],
						dataType: 'json',
						type: 'delete',
						success: function(result) {
							layer.close(loading);
							if (result.code === 0) {
								layer.msg(result.msg, {
									icon: 1,
									time: 1000
								}, function() {
									obj.del();
								});
							} else {
								layer.msg(result.msg, {
									icon: 2,
									time: 1000
								});
							}
						}
					})
				});
			}

			window.batchRemove = function(obj) {

				var checkIds = common.checkField(obj,'id');
				console.log(checkIds)
				if (checkIds === "") {
					layer.msg("未选中数据", {
						icon: 3,
						time: 1000
					});
					return false;
				}

				layer.confirm('确定要删除?', {
					icon: 3,
					title: '提示'
				}, function(index) {
					layer.close(index);
					let loading = layer.load();
					$.ajax({
						url: "{:url('addons.picwall.index/delete')}",
						dataType: 'json',
						type: 'delete',
						data:{"id":checkIds},
						success: function(result) {
							layer.close(loading);
							if (result.success) {
								layer.msg(result.msg, {
									icon: 1,
									time: 1000
								}, function() {
									table.reload('picwall-table');
								});
							} else {
								layer.msg(result.msg, {
									icon: 2,
									time: 1000
								});
							}
						}
					})
				});
			}

			window.refresh = function(param) {
				table.reload('picwall-table');
			}
  
  });
</script>
{/block}
{extend name="public:admin_form" /}

{block name="title"}发表作品{/block}
{block name="link"}
<style>
	.fly-panel {
		min-height: calc(100vh - 300px);
	}
	#ID-upload-image-preview, #ID-upload-video-preview {
		/*background: #faf1f1;*/
		height:100%;
	}

	.uploads-item {
		max-height: 300px;
		padding: 10px;
		margin-bottom: 10px;
	}
	.uploads-video-item {
		max-height: 300px;
		padding: 10px;
		margin-bottom: 10px;
		background: #e2e3e5;
	}

	#ID-upload-image {
		padding: 100px 0;
		width: 300px;
		height: 300px;

	}

	#ID-upload-video {
		padding: 100px 0;
	}

	#ID-upload-video-preview video {
		width: 100%;
		height: 280px;
	}

	#ID-upload-image-preview img, #ID-upload-video-preview img{
		width: 100%;
		height: 260px;
		object-fit: cover;
		margin-bottom: 10px;
	}

	.avatar-preview {
		margin-top: 15px;
	}


	.close {
		position: absolute; right:0px; top:0px; width:20px; height:20px;  border-radius: 10px;
		text-align: center; color: #fff;
	}

</style>
{/block}

{block name="body"}
<div class="layui-container fly-marginTop">
    <div class="fly-panel" pad20 >
      <!--<div class="fly-none">没有权限</div>-->
    	<div class="layui-form-pane" lay-filter="works-val-filter">
			<div class="layui-tab layui-tab-brief" lay-filter="media-upload">
				<ul class="layui-tab-title">
					<li lay-id="add-image" class="layui-this">精彩回顾</li>
					<li lay-id="add-video">视频集锦</li>
				</ul>
				<div class="layui-tab-content" id="LAY_ucm" lay-filter="upload-image-tab">
					{if config('taoler.config.is_post') == 1}
					<!--图片上传-->
					<div class="layui-tab-item layui-show">
						<div class="layui-form" wid100 lay-filter="upload-image">
							<div class="layui-form-item">
								<label for="L_title" class="layui-form-label">{:lang('title')}</label>
								<div class="layui-input-block">
									<input type="text" id="L_title" name="title" required lay-verify="required" autocomplete="off" class="layui-input" value=""/>
								</div>
							</div>

							<div class="layui-row layui-col-space10 layui-form-item " id="ID-upload-image-preview">
								<div class="layui-col-md3 layui-upload-drag"  id="ID-upload-image">
									<i class="layui-icon layui-icon-upload"></i>
									<div>点击上传，或将图片拖拽到此处</div>
								</div>
							</div>

							<div class="layui-form-item layui-form-text">
								<div class="layui-input-block">
									<textarea name="description" lay-verify="" placeholder="作品描述" class="layui-textarea"></textarea>
								</div>
							</div>

							<div class="layui-form-item">
								<input type="text" name="type" required lay-verify="required" class="layui-input layui-hide" value="1"/>
								<button type="submit" class="layui-btn" lay-filter="works-image-add" lay-submit id="works-image-add">{:lang('post now')}</button>
							</div>
						</div>

					</div>

					<!--视频上传-->
					<div class="layui-tab-item">
						<div class="layui-form" wid100 lay-filter="upload-video">
							<div class="layui-form-item">
								<label for="L_title" class="layui-form-label">{:lang('title')}</label>
								<div class="layui-input-block">
									<input type="text" id="L_title" name="title" required lay-verify="required" autocomplete="off" class="layui-input" value=""/>
								</div>
							</div>

							<div class="layui-form-item" id="ID-upload-video-preview">
							</div>
							
							<div class="layui-upload-drag" style="display: block;"  id="ID-upload-video">
								<i class="layui-icon layui-icon-upload"></i>
								<div>点击上传，或将视频拖拽到此处</div>
							</div>

							<div class="layui-form-item layui-form-text">
								<div class="layui-input-block">
									<textarea name="description" lay-verify="" placeholder="作品描述" class="layui-textarea"></textarea>
								</div>
							</div>

							<div class="layui-form-item">
								<input type="text" name="type" required lay-verify="required" class="layui-input layui-hide" value="2"/>
								<button type="submit" class="layui-btn" lay-filter="works-video-add" lay-submit id="works-video-add">{:lang('post now')}</button>
							</div>
						</div>
					</div>

					{else /}
					<div class="layui-form-item">抱歉，系统维护中，暂时禁止发帖！</div>
					{/if}
				</div>
			</div>
		</div>
	</div>
</div>
{/block}

{block name="js"}
<script>
	layui.use(['imagecut'], function () {
		var $ = layui.jquery,form = layui.form,upload = layui.upload;
		var layer = layui.layer;
		var imagecut = layui.imagecut;
		var element = layui.element;

		var videoAvatarId = 1;

		// 图片渲染
        upload.render({
            elem: '#ID-upload-image',
            url: "{:url('addons.media.index/uploads')}",
			auto: false,
			data: {type: 'image'},
			accept: 'images',
			acceptMime: 'image/*',
			exts: 'jpg|png|gif|bmp|jpeg',
			choose: function(obj){

				imagecut.upload(obj);
			},
            done: function(res,index, upload){
				var loadIndex = layer.load(2);
				if(res.status == 0){
					layer.close(loadIndex)
					layer.msg(res.msg);
                    var $html = 
                        '<div class="layui-col-md3 uploads-item" style="position: relative;">' +
						'<img src="'+res.url+'">' +
						'<div class="layui-input-block" style="margin-left:0">'+
						'<input type="text" name="urls[]" value="'+ res.url +'" class="layui-hide">' +
                        '<input type="text" name="tags[]" value="" placeholder="作品标签" class="layui-input">' +
						'<input type="text" name="types[]" value="image" class="layui-input layui-hide">' +
                        '</div>'+
                        '<img src="/static/addons/media/img/close-red.svg" class="close" style="width: 25px; height:25px;">' +
                        '</div>';

					$('#ID-upload-image').before($html);
				} else {
					layer.msg(res.msg);
					layer.close(loadIndex)
				}
            },
			// progress: function(n, elem, e, index){ // 注意：index 参数为 layui 2.6.6 新增
			// 	element.progress('progress-demo-'+ index, n + '%'); // 执行进度条。n 即为返回的进度百分比
			// }
        });


		// 视频渲染
		upload.render({
			elem: '#ID-upload-video',
			url: "{:url('addons.media.index/uploads')}",
			auto: true,
			data: { type: 'video'},
			accept: 'video',
			acceptMime: 'video/*',
			exts: 'mp4',
			choose: function(obj){
				layer.load(2);
			},
			done: function(res,index, upload){
				var loadIndex = layer.load(2);
				var data = form.val('works-val-filter');
				if(res.status == 0){
					layer.closeAll('loading');
					layer.msg(res.msg);
					var $html =
							'<div class="layui-row layui-col-space10  uploads-video-item" style="position: relative;">' +
								'<div class="layui-col-md3" >' +
									'<video src="'+res.url+'" width="100%" controls></video>' +
									'<input type="text" name="urls[]" value="'+ res.url +'" class="layui-hide">' +
								'</div>' +
								'<div class="layui-col-md9 uploads-item">' +
									'<div class="layui-form-item">' +
										'<label class="layui-form-label">添加标签</label>' +
										'<div class="layui-input-block">' +
										'<input type="text" name="tags[]" value="" placeholder="视频标签" class="layui-input">' +
										'<input type="text" name="types[]" value="video" class="layui-input layui-hide">' +
										'</div>' +
									'</div>' +
									'<div class="layui-form-item">' +
										'<label class="layui-form-label">添加封面</label>' +
										'<div class="layui-input-inline">' +
										'<input type="text" name="avatars[]" value="" required lay-verify="required"  placeholder="封面地址" class="layui-input">' +
										'</div>' +
										'<button type="button" class="layui-btn image-class-accept" id="image-class-accept-' + videoAvatarId + '" lay-options="{accept: \'images\'}">上传封面</button>' +
										'<div class="avatar-preview"></div>' +
									'</div>' +

								'</div>' +
								'<img src="/static/addons/media/img/close-red.svg" class="close" style="width: 25px; height:25px;">' +
							'</div>';

					$('#ID-upload-video-preview').append($html);
					//封面
					var ID = '#image-class-accept-' + videoAvatarId;
					videoPlaying(res.url).then(res => {
						$(ID).nextAll('div').append('<img src="' + res + '" style="width:150px;height:150px;">');
						$(ID).prev().children('input').val(res);
					});
				} else {
					layer.msg(res.msg);
					layer.close(loadIndex)
				}

				//封面
				upAvatar('#image-class-accept-' + videoAvatarId);
				videoAvatarId++;
				form.render();
			}
		});

		// 上传封面
		function upAvatar(ID) {
			upload.render({
				elem: ID,
				url: "{:url('addons.media.index/uploads')}",
				auto: false,
				data: {type: 'image'},
				accept: 'images',
				acceptMime: 'image/*',
				exts: 'jpg|png|gif|bmp|jpeg',
				choose: function(obj){
					layer.load(2);
					imagecut.upload(obj);
				},
				done: function(res,index, upload){
					layer.closeAll('loading');
					if(res.status == 0){
						layer.msg(res.msg);
						$(ID).prev().children('input').val(res.url);
						$(ID).nextAll('div').append('<img src="'+ res.url +'" style="width: 150px; height: 150px;">');
					} else {
						layer.msg(res.msg);
					}
				}
			});
		}

		// 视频播放js
		/**
		 url@ （为.MP4的视频链接）
		 调用方式 videoPlaying(url).then(res=>{
                // 这里就可以获取到你想要的视频帧图片
                console.log(res)
            })
		 */
		let videoPlaying = function (url) {
			// 第一步先创建video标签
			let video = document.createElement("VIDEO");
			// 设置缩略图的缩放比例
			let slide = 0.8;
			// 有的同学可能会出现跨域现象，这里设置
			video.crossOrigin = "anonymous";
			// 设置video标签的src属性 src为视频的播放地址
			video.setAttribute("src", url);
			// 截取自定义帧数（这里可以不设置，如果不设置有可能会截取白屏，建议设置为1或者自定的帧数）
			video.currentTime = 1
			// 这里使用 promise 原因是：因为canvas绘图需要时间，程序需要时间执行，采用异步返回
			return new Promise((resolve, reject) => {
				// 这里是video的监听函数，不懂的同学去w3c 或者 菜鸟教程 查看 （监听video就绪之后就开始使用canvas绘图）
				video.addEventListener('loadeddata', function () {
					// 绘图就不用我多说了吧，创建画板
					let canvas = document.createElement("canvas");
					// 设置画板宽高 比例
					canvas.width = video.videoWidth * slide;
					canvas.height = video.videoHeight * slide;
					// 获取画板上下文执行绘图 直接把video 丢进去 就可以了
					canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

					// 这里可以自行扩展，我这里是直接返回base64的串
					// let img = document.createElement("img");
					// img.src = canvas.toDataURL("image/png");
					// console.log('url', canvas.toDataURL("image/png"))

					$.post("{:url('addons.media.index/saveBase')}",{base64: canvas.toDataURL("image/png")},function (res){

						if(res.code == 0) {
							resolve(res.url);
						}

					})

					// 返回
					// resolve(canvas.toDataURL("image/png"))
				});
			})
		}


		// 发布图片
		form.on("submit(works-image-add)", function (data) {
			var field = data.field;
			var index = layer.load(1);
			$.ajax({
				type: "post",
				url: "{:url('addons.media.index/add')}",
				data: field,
				dataType: "json",
				success: function (res) {
					layer.close(index);
					if (res.code === 0) {
                      layer.msg(res.msg, {
                          icon: 1,
                          time: 1000
                      }, function() {
                          // parent.layui.table.reload("cate-table");
                          parent.layer.close(parent.layer.getFrameIndex(window.name)); //关闭当前页
                          window.parent.location.reload();
                      });
                  	} else {
                      layer.msg(res.msg, {
                          icon: 2,
                          time: 1000
                      });
                  }
				},
			});
			return false;
		});

		// 发布视频
		form.on("submit(works-video-add)", function (data) {
			var field = data.field;
			var index = layer.load(1);
			$.ajax({
				type: "post",
				url: "{:url('addons.media.index/add')}",
				data: field,
				dataType: "json",
				success: function (res) {
					layer.close(index);
					if (res.code === 0) {
                      layer.msg(res.msg, {
                          icon: 1,
                          time: 1000
                      }, function() {
                          // parent.layui.table.reload("cate-table");
                          parent.layer.close(parent.layer.getFrameIndex(window.name)); //关闭当前页
                          window.parent.location.reload();
                      });
                  	} else {
                      layer.msg(res.msg, {
                          icon: 2,
                          time: 1000
                      });
                  }
				},
			});
			return false;
		});

		//删除图片入库数据
		$("#ID-upload-image-preview").on('click','.close',function(){
            $(this).parent().remove();
		})

		//删除视频入库数据
		$("#ID-upload-video-preview").on('click','.close',function(){
			$(this).parent().remove();
		})

		// hash 地址定位
		var hashName = 'tabid'; // hash 名称
		var layid = location.hash.replace(new RegExp('^#'+ hashName + '='), ''); // 获取 lay-id 值

		// 初始切换
		element.tabChange('media-upload', layid);
		// 切换事件
		element.on('tab(media-upload)', function(obj){
			location.hash = hashName +'='+ this.getAttribute('lay-id');
		});

	});
</script>

{/block}
